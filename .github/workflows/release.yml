name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y glib-2.0 zip
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Update version in source files
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        
        # Update version in indicator.js (_showAbout method)
        sed -i "s/Extension version: [0-9]\+\.[0-9]\+\.[0-9]\+/Extension version: ${VERSION}/g" indicator.js
        
        # Update version in prefs.js (about section)
        sed -i "s/Version [0-9]\+\.[0-9]\+\.[0-9]\+ |/Version ${VERSION} |/g" prefs.js
        
        # Verify changes
        echo "=== indicator.js version ==="
        grep -n "Extension version:" indicator.js || true
        echo "=== prefs.js version ==="
        grep -n "Version.*|" prefs.js || true
    
    - name: Extract changelog for version
      id: changelog
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        # Extract section between current version and next version header
        CHANGELOG=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
        # Write to file for body_path
        echo "$CHANGELOG" > /tmp/release_notes.md
        # Add installation instructions
        cat >> /tmp/release_notes.md << 'EOF'

        ## Installation

        Download the `gp-gnome@totoshko88.github.io.zip` file and install:

        ```bash
        gnome-extensions install gp-gnome@totoshko88.github.io.zip --force
        gnome-extensions enable gp-gnome@totoshko88.github.io
        ```

        Then restart GNOME Shell (Wayland: log out/in, X11: Alt+F2 → r → Enter)

        ## Requirements

        - GNOME Shell 45, 46, 47, 48, or 49
        - GlobalProtect CLI installed
        EOF
    
    - name: Create distribution package
      run: |
        make dist
    
    - name: List dist contents
      run: ls -la dist/
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: gp-gnome v${{ steps.get_version.outputs.VERSION }}
        body_path: /tmp/release_notes.md
        files: |
          dist/gp-gnome@totoshko88.github.io.zip
        draft: false
        prerelease: false
